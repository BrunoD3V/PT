@using System.Collections
@using System.Drawing
@using Jmelosegui.Mvc.GoogleMap
@using PTurismo.Helpers
@using System.Web.Script.Serialization
@using PTurismo.Models
@model PTurismo.ViewModels.MapaViewModel
@Scripts.Render("~/Scripts/script.js")

@{
    ViewBag.Title = "Home Page";
}

<div class="row">
    <div class="col-md-6 text-right">
        <img src="~/Content/Images/Logo/Logo1.png"/>
        <img src="~/Content/Images/Logo/Logo2.png"/>
    </div>
    <div class="col-md-6 text-right">
        <img src="~/Content/Images/Helper/help.png" width="50px" height="50px" />
    </div>
</div>

<div id="row-principal" class="row">
    <div id="mapafixe" class="col-md-5">
        @(Html.GoogleMap()
        .Name("map")
        .Height(600)
        .ApiKey("AIzaSyAYC419uGMGyG-Lhc5gPRxzRm1q2Uu1b-4")
        .Center(c => c.Latitude(41.130325).Longitude(-7.097716))
        .FitToMarkersBounds((bool)ViewData["FitToMarkersBounds"])

        .Draggable((bool)ViewData["draggable"])
        .Markers(m =>
        {
            foreach (var p in Model.Pois)
            {
                if (p.CategoriaID.Equals(1))
                {
                    m.Add()
                        .Latitude(p.latitude)
                        .Longitude(p.longitude)
                        .Icon("~/Content/Images/Icones/Igreja.png", new Size(100, 100), new Point(0, 0), new Point(100, 100));
                }else if (p.CategoriaID.Equals(3))
                {
                    m.Add()
                       .Latitude(p.latitude)
                       .Longitude(p.longitude)
                       .Icon("~/Content/Images/Icones/Capela.png", new Size(20, 32), new Point(0, 0), new Point(0, 32));
                }
                else if (p.CategoriaID.Equals(5))
                {
                    m.Add()
                        .Latitude(p.latitude)
                        .Longitude(p.longitude)
                        .Icon("~/Content/Images/Icones/Santuario.png", new Size(20, 32), new Point(0, 0), new Point(0, 32));
                }else
                {
                    m.Add()
                        .Latitude(p.latitude)
                        .Longitude(p.longitude);
                }
            }
        })
        .MarkerEvents(events => events.OnMarkerClick("markerClick"))
        )
    </div>
    <div id="dataShow" class="col-md-7">
        <div class="row">
            <h1 id="NomePoi" />
            <div id="Categoria"></div>
            <div id="Descricao"></div>
            <div id="Elemento"></div>
        </div>
        <div class="row bottom-left">
            <div class="col-xs-6 col-md-6 col-lg-6">
                <div class="thumbnail">
                    <div class="col-md-4">
                        <!--MUDAR IMAGEM-->
                        <img id="imgThumbnail" src="http://i.imgur.com/Hw1dyoP.png" alt="Generic placeholder thumbnail" />
                    </div>
                    <div class="col-md-8">
                        <!-- CONTEUDO A ESCREVER -->
                        SAMPLE
                    </div>
                </div>
            </div>
            
            <div class="col-xs-6 col-md-6 col-lg-6">
                <div class="thumbnail">
                    <div class="col-md-4">
                         <!--MUDAR IMAGEM-->
                        <img id="imgThumbnail" src="http://i.imgur.com/Hw1dyoP.png" alt="Generic placeholder thumbnail" />
                    </div>
                    <div class="col-md-8">
                        <!-- CONTEUDO A ESCREVER -->
                        SAMPLE
                    </div>
                </div>
            </div>
          
        </div>
        <div class="row bottom">
            <button class="btn btn-warning">NEXT</button>
        </div>
    </div>
</div>



@section scripts
{
    @(Html.GoogleMap().ScriptRegistrar())
    <script type="text/javascript">

        var pois = @JavaScriptConvert.SerializeObject(@Model.Pois);
        var categorias = @JavaScriptConvert.SerializeObject(@Model.Categorias);
        var elementos = @JavaScriptConvert.SerializeObject(@Model.Elementos);
        var galeriasPoi = @JavaScriptConvert.SerializeObject(Model.GaleriaPois);
        var filePathPoi = @JavaScriptConvert.SerializeObject(@Model.FilePathPois);

        
        function getElementos(elementos, id) {
            console.log(id);
            var eles = new Array();
            for (var i = 0; i < elementos.length; i++) {
                var obj = elementos[i];
                for (var key in obj) {
                    var attrName = key;
                    var attrValue = obj[key];

                    if (attrName === "PoiID" && attrValue == id) {

                        eles.push(elementos[i]);
                        console.log(eles[i]);
                    }
                }
            }
            return eles;
        }

        function getFilePathPoi(filePathPoi, galeriasPoi, id) {

            var files = new Array();
            var galerias = new Array();
            galerias = getGaleriasPoi(galeriasPoi, id);

            if (galerias.length > 0) {
                for (var i = 0; i < galerias.length; i++) {
                    var obj = galerias[i];
                    // console.log(obj);
                    for (var key in obj) {
                        var attrName = key;
                        var attrValue = obj[key];

                        if (attrName === "GaleriaPoiID") {
                            // console.log("attrValue =" + attrValue);
                            // console.log("attrName : " + attrName);
                            for (var j = 0; j < filePathPoi.length; j++) {
                                var objt = filePathPoi[j];


                                for (var k in objt) {
                                    var attName = k;
                                    var attValue = objt[k];
                                    //console.log("Nome: " + attName);
                                    //console.log("attValue = " + attValue);
                                    // console.log("attrValue =" + attrValue);

                                    if (attName === "GaleriaPoiID" && attrValue == attValue) {
                                        // console.log(filePathPoi[j]);
                                        files.push(filePathPoi[i]);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return files;
        }

        function getGaleriasPoi(galeriasPoi, id) {

            var galerias = new Array();
            for (var i = 0; i < galeriasPoi.length; i++) {
                var obj = galeriasPoi[i];
                for (var key in obj) {
                    var attrName = key;
                    var attrValue = obj[key];

                    if (attrName === "PoiID" && attrValue == id) {

                        galerias.push(galeriasPoi[i]);
                        //console.log(galeriasPoi[i]);
                    }
                }
            }
            return galerias;
        }
        function markerClick(args) {

            if (args.eventName === 'click') {
                var id = parseInt(args.id) + 1;
                var eles = new Array();
                try {
                    eles = getElementos(elementos, id);
                    console.log("AQUI");
                    console.log(eles[0]);
                } catch (err) {
                    $('#Elemento').html('<div></div>');
                }


                var catID = pois[args.id].CategoriaID;

                $('#NomePoi').html(pois[args.id].nome);
                $('#Descricao').html(pois[args.id].descricao);
                $('#Categoria').html(categorias[catID - 1].nome);

                if (eles.length > 1) {

                    for (var j = 0; j < eles.length; j++) {
                        console.log(eles[j]);
                        //TODO mostrar cada elemento do poi
                    }
                }

                var ficheiros = new Array();

                ficheiros = getFilePathPoi(filePathPoi, galeriasPoi, id);
                if (ficheiros.length > 0) {
                    console.log(ficheiros[0]);//TODO mostrar todos os ficheiros;
                    var ficheiro = "/Content/Images/" + ficheiros[0].FileName;
                    

                    $('#my_image').attr("src", ficheiro);
                } else {
                    $('#my_image').attr("src", "/Content/Images/f76e268d-ee7f-4a65-bf18-ad6d5fc3f6c0.jpeg");
                }
            }

        }

    </script>
}